<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<title>INTRODUCTORY INTERRUPTS &vert; PYNQER</title>
<meta name="description" content="To work with PYNQ in an unskilled or experimental manner.">
<meta name="keywords" content="">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xesscorp.github.io/pynqer/docs/_site/images/logo.png">
<meta name="twitter:title" content="Introductory Interrupts">
<meta name="twitter:description" content="To work with PYNQ in an unskilled or experimental manner.">
<meta name="twitter:creator" content="@xesscorp">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Introductory Interrupts">
<meta property="og:description" content="To work with PYNQ in an unskilled or experimental manner.">
<meta property="og:url" content="https://xesscorp.github.io/pynqer/docs/_site/blog/introductory-interrupts">
<meta property="og:site_name" content="PYNQer">
<meta property="og:image" content="https://xesscorp.github.io/pynqer/docs/_site/images/">





<link rel="canonical" href="https://xesscorp.github.io/pynqer/docs/_site/blog/introductory-interrupts">
<link href="https://xesscorp.github.io/pynqer/docs/_site/feed.xml" type="application/atom+xml" rel="alternate" title="PYNQer Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


    <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700|Open+Sans:400,600,300,800,700' rel='stylesheet' type='text/css'>
	<!-- <link rel="stylesheet" href="https://xesscorp.github.io/pynqer/docs/_site/assets/css/vendor/font-awesome.min.css"> -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://xesscorp.github.io/pynqer/docs/_site/assets/css/vendor/normalize.css">
    <link rel="stylesheet" href="https://xesscorp.github.io/pynqer/docs/_site/assets/css/vendor/nprogress.css">
    <link rel="stylesheet" href="https://xesscorp.github.io/pynqer/docs/_site/assets/css/vendor/foundation.min.css">
    <link rel="stylesheet" href="https://xesscorp.github.io/pynqer/docs/_site/assets/css/style.css">
    <link rel="stylesheet" href="https://xesscorp.github.io/pynqer/docs/_site/assets/css/post.css">



<!--Load Mathjax-->
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script>
        MathJax.Hub.Config({
            config: ["MMLorHTML.js"],
            extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js"],
            jax: ["input/TeX"],
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                processEscapes: false
            },
            TeX: {
                TagSide: "right",
                TagIndent: ".8em",
                MultLineWidth: "85%",
                equationNumbers: {
                   autoNumber: "AMS",
                },
                unicode: {
                   fonts: "STIXGeneral,'Arial Unicode MS'" 
                }
            },
            showProcessingMessages: false
        });
    </script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://xesscorp.github.io/pynqer/docs/_site/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://xesscorp.github.io/pynqer/docs/_site/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://xesscorp.github.io/pynqer/docs/_site/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://xesscorp.github.io/pynqer/docs/_site/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://xesscorp.github.io/pynqer/docs/_site/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://xesscorp.github.io/pynqer/docs/_site/images/apple-touch-icon-144x144-precomposed.png">

        
            <style type="text/css">@media only screen and (min-width:43.75em){.notepad-post-content div>p:first-child:first-letter{float:left;font-size:4.688rem;line-height:4.375rem;padding-top:.25rem;padding-right:.5rem;padding-left:.188rem;font-family:serif}}</style>
        
    </head>
    <body class="post-template" itemscope itemtype="http://schema.org/WebPage">
        
            <main id="notepad-post-container-simple" class="notepad-post-container-simple" role="main">
                <header class="notepad-post-header-simple">
                    <div class="notepad-post-menu-header-simple">
                        
                        <a class="notepad-blog-logo" href="https://xesscorp.github.io/pynqer/docs/_site">
                        <img src="https://xesscorp.github.io/pynqer/docs/_site/images/logo.png" alt="Blog Logo" />
                        </a>
                        <div class="notepad-blog-menu">
                            <div class="notepad-mobile-menu show-for-small">
                                <a href="#"><i class="fa fa-bars"></i></a>
                            </div>
                            <ul class="notepad-menu">
                                <li class="notepad-mobile-close-btn show-for-small text-right">
                                    <a href="#"><i class="fa fa-times"></i></a>
                                </li>
                                
                                <li>
                                    <a href="https://xesscorp.github.io/pynqer/docs/_site/">Home</a>
                                     
                                </li>
                                
                                <li>
                                    <a href="https://xesscorp.github.io/pynqer/docs/_site/blog">Blog</a>
                                     
                                </li>
                                
                                <li>
                                    <a href="http://github.com/xesscorp/PYNQer">Github</a>
                                     
                                </li>
                                
                                <li>
                                    <a href="https://xesscorp.github.io/pynqer/docs/_site/about">About</a>
                                     
                                </li>
                                            
                                <li><a href="https://xesscorp.github.io/pynqer/docs/_site/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
                            </ul>
                        </div>
                    </div>
                    
                <div class="notepad-post-title-simple row">
                    <div class="small-12 columns">
                        <div class="notepad-post-meta-simple">
                            <h1>Introductory Interrupts</h1>
                            <p>
                                by <strong>Dave Vandenbout</strong> &#8212; 
                                
                                
                                <strong><time datetime="2017-05-23T10:31:28-04:00">23 May 2017</time></strong>
                            </p>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- codein1 -->
                            <ins class="adsbygoogle"
                                style="display:inline-block;width:728px;height:90px"
                                data-ad-client="ca-pub-7466474470517357"
                                data-ad-slot="6700962438"></ins>
                            <script>
                                (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div>
                    </div>
                </div>
        </header>
        
        
            <article class="notepad-post-content post tag-simple">
        
        <div><h1 id="introductory-interrupts">Introductory Interrupts</h1>

<p>My <a href="https://xesscorp.github.io/pynqer/docs/_site/blog/ripping-the-lid-off">previous blog post</a>
showed how I used <em>polling</em> to get the state of the PYNQ’s pushbuttons and display them on the LEDs.
That’s a great way to burn through CPU cycles.</p>

<p>Anyone who’s programmed embedded microcontrollers knows <em>interrupts</em> provide
a more efficient solution that only checks the buttons when they change state.
Xilinx provides
<a href="https://github.com/Xilinx/PYNQ/blob/master/Pynq-Z1/notebooks/examples/asyncio_buttons.ipynb">this PYNQ demo</a>
that couples the ZYNQ interrupt hardware with Python’s
<a href="https://pymotw.com/3/asyncio/index.html">asyncio</a> features.</p>

<p>Unfortunately, I’m not very familiar with <code class="highlighter-rouge">asyncio</code>, and
<a href="http://lucumr.pocoo.org/2016/10/30/i-dont-understand-asyncio/">this post</a>
didn’t fill me with confidence.
But, eventually, I picked up enough to understand the basic concepts of an
explicit <em>event loop</em> that runs a set of <em>coroutines</em> encapsulated in <em>tasks</em>.</p>

<p>Then I got confused again because I couldn’t see where the Xilinx example
started the event loop.
It turns out that’s hidden in the <code class="highlighter-rouge">wait_for_value()</code> method of the
<a href="https://github.com/Xilinx/PYNQ/blob/master/python/pynq/board/switch.py"><code class="highlighter-rouge">Switch</code> object</a>:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">wait_for_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

    <span class="c"># Abort if the interrupt hardware isn't present in this overlay.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'Interrupts not available in this Overlay'</span><span class="p">)</span>

    <span class="c"># Get the default event loop.</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    
    <span class="c"># Encapsulate the wait_for_value_async() coroutine in a task and run it</span>
    <span class="c"># in the event loop until this button has the desired value.</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_for_value_async</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
</code></pre>
</div>

<p>Now if I just call <code class="highlighter-rouge">switch[0].wait_for_value(1)</code>, the event loop in the following cell will run
until I flip the switch:</p>

<div class="cell">
	<div class="prompt input-prompt">
	
		In
        
	[1]:</div>
	
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">Overlay</span>
<span class="kn">from</span> <span class="nn">pynq.board</span> <span class="kn">import</span> <span class="n">Switch</span>

<span class="c"># Make sure the base overlay is installed in the ZYNQ PL.</span>
<span class="n">Overlay</span><span class="p">(</span><span class="s">'base.bit'</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>

<span class="n">sw0</span> <span class="o">=</span> <span class="n">Switch</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        <span class="c"># Create Switch object for SW0.</span>
<span class="n">sw0</span><span class="o">.</span><span class="n">wait_for_value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># Push SW0 up to terminate this cell.</span>
<span class="k">print</span><span class="p">(</span><span class="s">'SW0 is 1!'</span><span class="p">)</span></code></pre></figure>

</div>

<div class="cell">
	<div class="prompt output-prompt">
	
		Out
        
	[1]:</div>
	
<figure class="highlight"><pre><code class="language-text" data-lang="text">SW0 is 1!</code></pre></figure>

</div>

<p>How is this any different than just polling?
The answer lies in the <code class="highlighter-rouge">wait_for_value_async()</code> coroutine.
It contains a loop, but it’s a loop that only runs whenever the interrupt circuitry detects a change
in the switch state:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="nd">@asyncio.coroutine</span>  <span class="c"># Make the following function into a coroutine that runs in an event loop.</span>
<span class="k">def</span> <span class="nf">wait_for_value_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

    <span class="c"># Abort if the overlay has no interrupt circuitry (see the next method).</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'Interrupts not available in this Overlay'</span><span class="p">)</span>
        
    <span class="c"># Only exit this loop when this switch has the desired value.</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
    
        <span class="c"># Pause this coroutine until one of the switches changes state and causes an interrupt.</span>
        <span class="k">yield</span> <span class="k">from</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        
        <span class="c"># If one of the switches caused the interrupt, then reset the interrupt flag.</span>
        <span class="k">if</span> <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mh">0x120</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">:</span>
            <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x120</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">)</span>
</code></pre>
</div>

<p>The interrupt hardware is setup in the <code class="highlighter-rouge">__init__()</code> method of the <code class="highlighter-rouge">Switch</code> object:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

    <span class="c"># Create the MMIO object that has register addresses for reading the switch state.</span>
    <span class="k">if</span> <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span> <span class="o">=</span> <span class="n">MMIO</span><span class="p">(</span><span class="n">PL</span><span class="o">.</span><span class="n">ip_dict</span><span class="p">[</span><span class="s">"SEG_swsleds_gpio_Reg"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">512</span><span class="p">)</span>
        
    <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>  <span class="c"># The index for this switch (either 0 or 1 for the PYNQ).</span>
    
    <span class="c"># Setup the interrupt hardware.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># No interrupts by default.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Create the interrupt object using info from the overlay.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">Interrupt</span><span class="p">(</span><span class="s">'swsleds_gpio/ip2intc_irpt'</span><span class="p">)</span>
        
        <span class="c"># Enable the interrupts using register addresses in the switch MMIO.</span>
        <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x11C</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">)</span>
        <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x128</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</code></pre>
</div>

<p>There are a few mysteries in the code shown above, such as where the addresses
for querying and clearing the switch interrupts come from.
(I suspect that will be answered by diving into the HDL code for the <code class="highlighter-rouge">base</code> overlay.)
Also, I haven’t looked into the operations of the <code class="highlighter-rouge">Interrupt</code> class.</p>

<p>But I’ve seen enough to replicate handling the switch interrupts.
The following code creates tasks that scan the switches whenever
an interrupt happens.
A separate task runs for a set time interval after which
the scanning stops and the CPU utilization over that interval is displayed.
(Note that in this code I’ve used the new <code class="highlighter-rouge">async</code> and <code class="highlighter-rouge">await</code> keywords
in place of <code class="highlighter-rouge">asyncio.coroutine</code> and <code class="highlighter-rouge">yield from</code>, respectively.)
So just run the following cell and see what happens.</p>

<div class="cell">
	<div class="prompt input-prompt">
	
		In
        
	[2]:</div>
	
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">psutil</span> <span class="kn">import</span> <span class="n">cpu_percent</span>
<span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">Overlay</span>
<span class="kn">from</span> <span class="nn">pynq.board</span> <span class="kn">import</span> <span class="n">Switch</span>

<span class="c"># Make sure the base overlay is installed in the ZYNQ PL.</span>
<span class="n">Overlay</span><span class="p">(</span><span class="s">'base.bit'</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>

<span class="c"># Create objects for both slide switches.</span>
<span class="n">switches</span> <span class="o">=</span> <span class="p">[</span><span class="n">Switch</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

<span class="c"># Coroutine that waits for a switch to change state.</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">show_switch</span><span class="p">(</span><span class="n">sw</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

        <span class="c"># Wait for the switch to change and then print its state.</span>
        <span class="n">await</span> <span class="n">sw</span><span class="o">.</span><span class="n">interrupt</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>  <span class="c"># Wait for the interrupt to happen.</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Switch[{num}] = {val}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">sw</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">sw</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

        <span class="c"># Clear the interrupt.</span>
        <span class="k">if</span> <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mh">0x120</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">:</span>
            <span class="n">Switch</span><span class="o">.</span><span class="n">_mmio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x120</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">)</span>

<span class="c"># Create a task for each switch using the coroutine and place them on the event loop.</span>
<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">show_switch</span><span class="p">(</span><span class="n">sw</span><span class="p">))</span> <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">]</span>
    
<span class="c"># Create a simple coroutine that just waits for a time interval to expire.</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">just_wait</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

<span class="c"># Run the event loop until the time interval expires,</span>
<span class="c"># printing the switch values as they change.</span>
<span class="n">time_interval</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c"># time in seconds</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">wait_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">just_wait</span><span class="p">(</span><span class="n">time_interval</span><span class="p">))</span>

<span class="c"># Surround the event loop with functions to record CPU utilization.</span>
<span class="n">cpu_percent</span><span class="p">(</span><span class="n">percpu</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># Initialize the CPU monitoring.</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">wait_task</span><span class="p">)</span>
<span class="n">cpu_used</span> <span class="o">=</span> <span class="n">cpu_percent</span><span class="p">(</span><span class="n">percpu</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Print the CPU utilization % for the interval.</span>
<span class="k">print</span><span class="p">(</span><span class="s">'CPU Utilization = {cpu_used}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>

<span class="c"># Remove all the tasks from the event loop.</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span></code></pre></figure>

</div>

<div class="cell">
	<div class="prompt output-prompt">
	
		Out
        
	[2]:</div>
	
<figure class="highlight"><pre><code class="language-text" data-lang="text">Switch[0] = 1
Switch[1] = 0
Switch[0] = 1
Switch[1] = 0
Switch[0] = 0
Switch[1] = 0
Switch[0] = 0
Switch[1] = 0
Switch[0] = 0
Switch[1] = 1
Switch[0] = 0
Switch[1] = 1
Switch[0] = 0
Switch[1] = 0
Switch[0] = 0
Switch[1] = 1
Switch[0] = 0
Switch[1] = 1
Switch[0] = 0
Switch[1] = 0
Switch[0] = 0
Switch[1] = 0
CPU Utilization = [0.8, 0.3]</code></pre></figure>

</div>

<p>While the code was running, I flipped each switch once.
For some reason, each transition of a switch caused the interrupt to be serviced twice.
(I still haven’t figured that out.)</p>

<p>At the end of the prescribed time interval, the utilization of each CPU is shown to
be less than 1%.
To compare this with the use of polling, I wrote the following code that scans each switch continuously:</p>

<div class="cell">
	<div class="prompt input-prompt">
	
		In
        
	[3]:</div>
	
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">scan_switch</span><span class="p">(</span><span class="n">sw</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sw_val</span> <span class="o">=</span> <span class="n">sw</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c"># Get the switch state.</span>
        
        <span class="c"># Print the switch state if it has changed.</span>
        <span class="k">if</span> <span class="n">sw</span><span class="o">.</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">sw_val</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Switch[{num}] = {val}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">sw</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">sw_val</span><span class="p">))</span>
            
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="c"># An exception occurs the 1st time thru because the switch state</span>
        <span class="c"># hasn't yet been stored in the object as an attribute.</span>
        <span class="k">pass</span>
    
    <span class="c"># Save the current state of the switch inside the switch object.</span>
    <span class="n">sw</span><span class="o">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">sw_val</span>

<span class="c"># Compute the end time for the polling.</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">10.0</span>

<span class="n">cpu_percent</span><span class="p">(</span><span class="n">percpu</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># Initialize the CPU monitoring.</span>

<span class="c"># Now poll the switches for the given time interval.</span>
<span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
        <span class="n">scan_switch</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
        
<span class="c"># Print the CPU utilization during the polling.</span>
<span class="n">cpu_used</span> <span class="o">=</span> <span class="n">cpu_percent</span><span class="p">(</span><span class="n">percpu</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'CPU Utilization = {cpu_used}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span></code></pre></figure>

</div>

<div class="cell">
	<div class="prompt output-prompt">
	
		Out
        
	[3]:</div>
	
<figure class="highlight"><pre><code class="language-text" data-lang="text">Switch[0] = 1
Switch[0] = 0
Switch[1] = 1
Switch[1] = 0
CPU Utilization = [0.5, 99.8]</code></pre></figure>

</div>

<p>Once again, I flipped each switch while the code was running.
Only now the utilization is near 100% for one of the CPUs, showing the 
interrupt-based code is much more efficient than polling.</p>

<h2 id="pertinent-files">Pertinent Files</h2>

<p>Here is a list of the files I examined while making this blog post:</p>

<ul>
  <li><a href="https://github.com/Xilinx/PYNQ/blob/master/python/pynq/board/switch.py"><code class="highlighter-rouge">switch.py</code></a>: 
Defines the <code class="highlighter-rouge">Switch</code> class for reading the state of the slide switches and handling their interrupts.</li>
  <li><a href="https://github.com/xesscorp/pynqer/tree/master/Notebooks/introductory_interrupts.ipynb">This Jupyter notebook</a>:
Contains the executable notebook from which this post was generated.</li>
</ul>

        </div>
        <div style="text-align: center;">
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- codein2-footer -->
<!--
        <ins class="adsbygoogle"
            style="display:inline-block;width:728px;height:90px"
            data-ad-client="ca-pub-7466474470517357"
            data-ad-slot="9952356430"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
-->
        </div>
        </article>
        <div class="cf"></div>
                <div class="row text-center">
            <section class="notepad-post-share">
                <a class="twitter-icon" href="https://twitter.com/intent/tweet?text=&quot;Introductory Interrupts&quot;%20https://xesscorp.github.io/pynqer/docs/_site/blog/introductory-interrupts%20via%20&#64;xesscorp"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
                    <i class="fa fa-twitter"></i>
                </a>
                <a class="facebook-icon" href="https://www.facebook.com/sharer/sharer.php?u=https://xesscorp.github.io/pynqer/docs/_site/blog/introductory-interrupts"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
                    <i class="fa fa-facebook"></i>
                </a>
                <a class="google-icon" href="https://plus.google.com/share?url=https://xesscorp.github.io/pynqer/docs/_site/blog/introductory-interrupts"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">
                    <i class="fa fa-google-plus"></i>
                </a>
            </section>
        </div>
        <div class="cf"></div>
                    <div class="notepad-author-info">
                <div class="row">
                    <section class="notepad-post-author small-12 columns">
                        <img src="https://xesscorp.github.io/pynqer/docs/_site/images/devb-pic.jpg" class="notepad-post-author-avatar" alt="Dave Vandenbout's photo">
                        <span class="author-label">Author:</span>
                        <h1>Dave Vandenbout</h1>
                        <p><a href="mailto:devb@xess.com" class="author-website">devb@xess.com</a>
                        <p>Relax, I do this stuff for a living.</p>
                    </section>
                </div>
            </div>
 
        <div class="cf"></div>
        
        <div class="cf"></div>
        <footer class="notepad-site-footer">
    <div class="copyright">
        <section>
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
            </a>
            <br /><br />
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">PYNQer website</span> by 
            <a xmlns:cc="http://creativecommons.org/ns#" href="www.xess.com" property="cc:attributionName" rel="cc:attributionURL">
                XESS Corporation
            </a> 
            is licensed under a 
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                Creative Commons Attribution 4.0 International License
            </a>.
        </section>
        <br />
        <p>
            <a href='http://www.catb.org/hacker-emblem/' target="_blank"><img src='https://xesscorp.github.io/pynqer/docs/_site/assets/img/hacker.png' alt='hacker emblem' /></a>
            <a href="http://endsoftpatents.org/innovating-without-patents" target="_blank"><img style="border-width:0" src="https://xesscorp.github.io/pynqer/docs/_site/assets/img/patent-free.png"></a>
        </p>
    </div>
    <div class="social-icons">
        
        
        <a href="http://twitter.com/xesscorp">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-twitter fa-stack-1x"></i>
            </span>
        </a>
        
        
        
        
        <a href="http://github.com/xesscorp">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-github fa-stack-1x"></i>
            </span>
        </a>
        
        
    </div>
    
    <div class="cf"></div>
</footer>
 
        </main>    
            <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="https://xesscorp.github.io/pynqer/docs/_site/assets/js/vendor/jquery-1.11.1.min.js"><\/script>')</script>
    <script src="https://xesscorp.github.io/pynqer/docs/_site/assets/js/vendor/modernizr.js"></script>
    <script src="https://xesscorp.github.io/pynqer/docs/_site/assets/js/foundation.min.js"></script>
    
    <script src="https://xesscorp.github.io/pynqer/docs/_site/assets/js/notepad.js"></script>
    <script src="https://xesscorp.github.io/pynqer/docs/_site/assets/js/scripts.min.js"></script>
    <script src="https://xesscorp.github.io/pynqer/docs/_site/assets/js/vendor/nprogress.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/sigma.js/1.0.3/sigma.min.js"></script>

    <script>
      $(document).foundation();
    </script>


<script>NProgress.start();var interval=setInterval(function(){NProgress.inc()},1000);jQuery(window).load(function(){clearInterval(interval);NProgress.done()});jQuery(window).unload(function(){NProgress.start()});</script>
 
    </body>
</html>